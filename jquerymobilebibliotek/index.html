<!doctype html>
<html manifest="manifest.appcache">
<head>
  <title>Bibliotek.dk app</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- meta name="description" content=""-->
  <meta name="author" content="DBC/rje">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320"/>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon-precomposed" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-startup-image" href="splash.png">
  <link rel="stylesheet" href="lib/jquery.mobile-1.0rc1.min.css">
  <style>
    .searchresult {
        margin: 1ex;
        padding: 1ex;
        border: solid;
        border-width: 1px;
        border-radius: .5ex;
    }
    .searchresult .title {
        font-weight: bold;
    }
    .searchresult .author {
        font-size: 70%;
    }
    .searchresult .bibentries {
        height: 0px;
        overflow: hidden;
        transition: height 400ms;
        -webkit-transition: height 400ms;
        -mox-transition: height 400ms;
    }
    .searchresult .bibentries th {
        font-size: 70%;
        font-weight: normal;
        font-weight: 200;
        text-align: right;
        width: 20%;
    }
    .searchresult .bibentries td {
        width: 80%;
    }
  </style>
</head>
<body>
<noscript>Requires JavaScript enabled :(</noscript>

<div data-role="page" id="frontpage">
    <div data-role="header">
        <h1>bibliotek.dk</h1>
    </div>
    <div data-role="content">  
        <div class="content-primary query">
            <h2>Søg i bibliotek.dk</h2>
            <form id="frontpageSearch">
            <fieldset data-role="controlgroup" data-type="horizontal">
                    <input type="radio" name="material" id="material-any" value="any" checked="checked" />
                    <label for="material-any">Alle</label>
        
                    <input type="radio" name="material" id="material-books" value="books"  />
                    <label for="material-books">Bøger</label>
        
                    <input type="radio" name="material" id="material-music" value="music"  />
                    <label for="material-music">Musik</label>
        
                    <input type="radio" name="material" id="material-movie" value="movie"  />
                    <label for="material-movie">Film</label>
            </fieldset>
            <input type="search" name="query" id="query" value="" />
            <button data-inline='true'>Søg</button>
            </form>
        </div>
        <div class="content-secondary"><form>
            <h2>Log ind</h2>
                <input type="email" placeholder="email" name="email" value=""  />
                <input type="password" placeholder="kodeord" name="name" value=""  />
                <button data-inline='true'>Log ind</button>
        </form></div>
    </div>
</div>

<div data-role="page" id="searchresultpage">
    <div data-role="header">
        <a href="#frontpage" data-icon="home" data-iconpos="notext" class="ui-btn-left" data-direction="reverse">Forside</a>
        <h1>bibliotek.dk</h1>
    </div>
    <div data-role="content" id="hits">  
        <h2>Søgeresultater for <span id="searchresultquery"></span></h2>
        <input type="search" name="query" id="query" value="" />
        <button data-inline='true'>Søg</button>
        <div id="numhits"></div>
        <div id="searchresults"></div>
        <div id="searchResultsLoading">Flere resultater...</div>
    </div>
</div>

<script type="text/javascript" language="javascript" src="lib/es5-shim.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/jquery-1.6.4.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/jquery.mobile-1.0rc1.min.js"></script>
<script type="text/javascript" language="javascript" src="bibdk.js"></script>
<script>
</script>
<!--script type="text/javascript" language="javascript" src="lib/phonegap-1.1.0.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/underscore-min.js"></script>
<script type="text/javascript" language="javascript" src="lib/backbone-min.js"></script>
<script type="text/javascript" language="javascript" src="main.js"></script-->
<script>
$(function(){
    function searchResults(material, query) {
        $.mobile.changePage("#searchresultpage");
        $("#searchresultquery").text(query);
        $('#numhits').text("");
        $("#searchresults").html("");
        $(document).unbind("scroll");

        var pos = 0;

        function update() {
            $(document).unbind("scroll", onScreen);
            $("#searchResultsLoading").unbind("click", update);
            $("#searchResultsLoading").html("loading...");
            var moreHits = true;
            bibdk.search({cql: query, start: pos, count: 6, callback: function(result) {
                $('#numhits').text("Fundet " + result.hitCount + " poster:");
                result.collections.map(function(entries) { 
                    $('#searchresults').append( 
                        $('<div class="searchresult">')
                            .append($('<div class="title">').text(entries[0].title && entries[0].title[0]))
                            .append($('<div class="author">').text((entries[0].creator || entries[0]["oss:aut creator"] || entries[0]["dkdcplus:aut creator"] || [""]).join(" & ")))
                            .append(XXX = '<div class="bibentries">' + entries.map(function(entry) { 
                                    var acc = [];
                                    acc.push('<div class="bibentry"><table>');
                                    Object.keys(entry).forEach(function(key) {
                                        entry[key].forEach(function(value) {
                                            acc.push('<tr><th>');
                                            acc.push(key);
                                            acc.push('</th><td>');
                                            acc.push(value);
                                            acc.push('</td></tr>');
                                        });
                                    });
                                    acc.push('</table></div>');
                                    return acc.join('');
                                }).join('') + '</div>')
                            .bind('click', function() {
                                var $prop = $(this).find(".bibentries");
                                if($prop.css('height') === "0px") {
                                    $prop.css('height', 'auto');
                                    var newheight = $prop.height();
                                    $prop.css('height', newheight+'px');
                                } else {
                                    if ($(this).offset().top < window.pageYOffset) {
                                        window.scrollTo(0, $(this).offset().top); 
                                    }
                                    $prop.css('height', '0px');
                                }
                            })
                    );
                });

                pos += 6;
                if(pos < result.hitCount) {
                    $("#searchResultsLoading").html("Klik her for flere resultater.");
                    $(document).bind("scroll", onScreen);
                    $("#searchResultsLoading").bind("click", update);
                    onScreen();
                } else {
                    $("#searchResultsLoading").html("");
                }
            }});
        }

        function onScreen() {
            if ($("#searchResultsLoading").offset() && $("#searchResultsLoading").offset().top <
                    window.innerHeight*2 + window.pageYOffset) {
                update();
            }
        };
        $(document).bind("scroll", onScreen);
        $("#searchResultsLoading").bind("click", update);
        onScreen();
    }

    $("#frontpageSearch").submit(function() {
        var material = $('#frontpageSearch input:radio[name=material]:checked').val();
        var query = $('#frontpageSearch input[name=query]').val();
        searchResults(material, query);
        return false;
    });
});
    
</script>
</body>
</html>
