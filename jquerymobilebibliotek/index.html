<!doctype html>
<html manifest="manifest.appcache">
<head>
  <title>Bibliotek.dk app</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- meta name="description" content=""-->
  <meta name="author" content="DBC/rje">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320"/>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon-precomposed" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-startup-image" href="splash.png">
  <link rel="stylesheet" href="lib/jquery.mobile-1.0rc1.min.css">
  <style>
    .searchresult {
        margin: 1ex;
        border-width: 1px;
    }
    .searchresult .title {
        font-weight: bold;
    }
    .searchresult .author {
        font-size: 70%;
    }
  </style>
</head>
<body>
<noscript>Requires JavaScript enabled :(</noscript>

<div data-role="page" id="frontpage">
    <div data-role="header">
        <h1>bibliotek.dk</h1>
    </div>
    <div data-role="content">  
        <div class="content-primary query">
            <h2>Søg i bibliotek.dk</h2>
            <form id="frontpageSearch">
            <fieldset data-role="controlgroup" data-type="horizontal">
                    <input type="radio" name="material" id="material-any" value="any" checked="checked" />
                    <label for="material-any">Alle</label>
        
                    <input type="radio" name="material" id="material-books" value="books"  />
                    <label for="material-books">Bøger</label>
        
                    <input type="radio" name="material" id="material-music" value="music"  />
                    <label for="material-music">Musik</label>
        
                    <input type="radio" name="material" id="material-movie" value="movie"  />
                    <label for="material-movie">Film</label>
            </fieldset>
            <input type="search" name="query" id="query" value="" />
            <button data-inline='true'>Søg</button>
            </form>
        </div>
        <div class="content-secondary"><form>
            <h2>Log ind</h2>
                <input type="email" placeholder="email" name="email" value=""  />
                <input type="password" placeholder="kodeord" name="name" value=""  />
                <button data-inline='true'>Log ind</button>
        </form></div>
    </div>
</div>

<div data-role="page" id="searchresultpage">
    <div data-role="header">
        <a href="#frontpage" data-icon="home" data-iconpos="notext" class="ui-btn-left" data-direction="reverse">Forside</a>
        <h1>bibliotek.dk</h1>
    </div>
    <div data-role="content" id="hits">  
        <h2>Søgeresultater for <span id="searchresultquery"></span></h2>
        <div id="numhits"></div>
        <div id="searchresults"></div>
        <div id="searchResultsLoading">Flere resultater...</div>
    </div>
</div>

<script type="text/javascript" language="javascript" src="lib/es5-shim.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/jquery-1.6.4.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/jquery.mobile-1.0rc1.min.js"></script>
<!--script type="text/javascript" language="javascript" src="lib/phonegap-1.1.0.min.js"></script>
<script type="text/javascript" language="javascript" src="lib/underscore-min.js"></script>
<script type="text/javascript" language="javascript" src="lib/backbone-min.js"></script>
<script type="text/javascript" language="javascript" src="main.js"></script-->
<script>
$(function(){
    function processDKABM(xml) {
        var results = [];
        for(var i = 0; i  < xml.length; ++i) {
            var result = {};
            var dkabm = xml[i].record;
            console.log(dkabm);
            Object.keys(dkabm).forEach(function(key){
                if(key.charAt(0) !== "@") 
                dkabm[key].forEach(function(value){
                    var newkey = key;
                    if(value["@type"]) {
                        newkey += " " + value["@type"].$;
                    }
                    if(!result[newkey]) {
                        result[newkey] = [];
                    }
                    result[newkey].push(value.$);
                });
            });
            results.push(result);
        }
        return result;
    };

    function fetchHits(query, start, stepValue, hits, callback) {
        $.ajax({
            url: 'http://opensearch.addi.dk/2.0/',
            data: {
                action: 'search',
                query: query,
                start: start,
                stepValue: stepValue,
                outputType: 'json'},
            dataType: 'jsonp',
            success: function (result) {
                console.log("got result");
                console.log(result);
                for(var i=0;i<+result.searchResponse.result.collectionCount.$;++i) {
                    if(result.searchResponse.result.searchResult[i]) {
                        hits[i+start] = processDKABM(result.searchResponse.result.searchResult[i].collection.object);
                    }
                }
                callback(hits, result.searchResponse.result.hitCount.$);
            }});
    }


    function searchResults(material, query) {
        $.mobile.changePage("#searchresultpage");
        $('#numhits').text("Søger...");
        $("#searchresults").html("");

        var pos = 1;
        function update() {
            $(document).unbind("scroll", onScreen);
            $("#searchResultsLoading").unbind("click", update);
            $("#searchResultsLoading").html("loading...");
            var moreHits = true;
            fetchHits(query, pos, 5, [[]], function(result, numhits) {
                $('#numhits').text("Fundet " + numhits + " poster");
                //$('#searchresults').append( $('<pre>').text(JSON.stringify(result, null, "   ")));
                for(var i=pos;i<result.length;++i) {
                    $('#searchresults').append( 
                        $('<div class="searchresult">')
                            .append($('<div class="title">').text(result[i].title && result[i].title[0]))
                            .append($('<div class="author">').text(result[i].creator && result[i].creator.join(" & ")))
                    );
                }
                pos = result.length;
                if(result.length <= numhits) {
                    $("#searchResultsLoading").html("Klik her for flere resultater.");
                    $(document).bind("scroll", onScreen);
                    $("#searchResultsLoading").bind("click", update);
                    onScreen();
                } else {
                    $("#searchResultsLoading").html("");
                }
            });
        }

        function onScreen() {
            if ($("#searchResultsLoading").offset() && $("#searchResultsLoading").offset().top <
                    window.innerHeight*1.5 + window.pageYOffset) {
                update();
            }
        };
        $(document).bind("scroll", onScreen);
        $("#searchResultsLoading").bind("click", update);
        onScreen();
    }


    function search(material, query) {
        $.mobile.changePage("#searchresultpage");
        $("#searchresultquery").text(query);
        $('#numhits').text("Søger...");
        $("#searchresults").html("");
        fetchHits(query, 1, 5, [[]], function(result, numhits) {
            $('#numhits').text("Fundet " + numhits + " poster");
            //$('#searchresults').append( $('<pre>').text(JSON.stringify(result, null, "   ")));
            for(var i=1;i<=5;++i) {
                $('#searchresults').append( 
                    $('<div class="searchresult">')
                        .append($('<div class="title">').text(result[i].title[0]))
                        .append($('<div class="author">').text(result[i].creator.join(" & ")))
                );
            }
        });
    }

    $("#frontpageSearch").submit(function() {
        var material = $('#frontpageSearch input:radio[name=material]:checked').val();
        var query = $('#frontpageSearch input[name=query]').val();
        console.log("search",material, query);
        searchResults(material, query);
        return false;
    });
});
    
</script>
</body>
</html>
